From e89d4c97385ff8180e6e81e84c5aa745daf28a79 Mon Sep 17 00:00:00 2001
From: Thorsten Kukuk <kukuk@thkukuk.de>
Date: Mon, 22 Jun 2015 14:53:01 +0200
Subject: Release version 1.2.1

Security fix: CVE-2015-3238

If the process executing pam_sm_authenticate or pam_sm_chauthtok method
of pam_unix is not privileged enough to check the password, e.g.
if selinux is enabled, the _unix_run_helper_binary function is called.
When a long enough password is supplied (16 pages or more, i.e. 65536+
bytes on a system with 4K pages), this helper function hangs
indefinitely, blocked in the write(2) call while writing to a blocking
pipe that has a limited capacity.
With this fix, the verifiable password length will be limited to
PAM_MAX_RESP_SIZE bytes (i.e. 512 bytes) for pam_exec and pam_unix.

Index: pam-1.1.3/modules/pam_exec/pam_exec.8.xml
===================================================================
--- pam-1.1.3.orig/modules/pam_exec/pam_exec.8.xml	2016-03-17 13:08:26.300138793 -0500
+++ pam-1.1.3/modules/pam_exec/pam_exec.8.xml	2016-03-17 13:08:26.292138836 -0500
@@ -100,7 +100,8 @@
               During authentication the calling command can read
               the password from <citerefentry>
               <refentrytitle>stdin</refentrytitle><manvolnum>3</manvolnum>
-              </citerefentry>.
+              </citerefentry>. Only first <emphasis>PAM_MAX_RESP_SIZE</emphasis>
+              bytes of a password are provided to the command.
             </para>
           </listitem>
         </varlistentry>
Index: pam-1.1.3/modules/pam_exec/pam_exec.c
===================================================================
--- pam-1.1.3.orig/modules/pam_exec/pam_exec.c	2016-03-17 13:08:26.300138793 -0500
+++ pam-1.1.3/modules/pam_exec/pam_exec.c	2016-03-17 13:08:26.292138836 -0500
@@ -150,11 +150,11 @@ call_exec (const char *pam_type, pam_han
 		}
 
 	      pam_set_item (pamh, PAM_AUTHTOK, resp);
-	      authtok = strdupa (resp);
+	      authtok = strndupa (resp, PAM_MAX_RESP_SIZE);
 	      _pam_drop (resp);
 	    }
 	  else
-	    authtok = void_pass;
+	    authtok = strndupa (void_pass, PAM_MAX_RESP_SIZE);
 
 	  if (pipe(fds) != 0)
 	    {
Index: pam-1.1.3/modules/pam_unix/pam_unix.8.xml
===================================================================
--- pam-1.1.3.orig/modules/pam_unix/pam_unix.8.xml	2016-03-17 13:08:26.300138793 -0500
+++ pam-1.1.3/modules/pam_unix/pam_unix.8.xml	2016-03-17 13:08:26.292138836 -0500
@@ -80,6 +80,13 @@
     </para>
 
     <para>
+      The maximum length of a password supported by the pam_unix module
+      via the helper binary is <emphasis>PAM_MAX_RESP_SIZE</emphasis>
+      - currently 512 bytes. The rest of the password provided by the
+      conversation function to the module will be ignored.
+    </para>
+
+    <para>
       The password component of this module performs the task of updating
       the user's password.
     </para>
Index: pam-1.1.3/modules/pam_unix/pam_unix_passwd.c
===================================================================
--- pam-1.1.3.orig/modules/pam_unix/pam_unix_passwd.c	2016-03-17 13:08:26.300138793 -0500
+++ pam-1.1.3/modules/pam_unix/pam_unix_passwd.c	2016-03-17 13:08:26.292138836 -0500
@@ -236,15 +236,22 @@ static int _unix_run_update_binary(pam_h
 	/* wait for child */
 	/* if the stored password is NULL */
         int rc=0;
-	if (fromwhat)
-	  pam_modutil_write(fds[1], fromwhat, strlen(fromwhat)+1);
-	else
-	  pam_modutil_write(fds[1], "", 1);
-	if (towhat) {
-	  pam_modutil_write(fds[1], towhat, strlen(towhat)+1);
+	if (fromwhat) {
+	    int len = strlen(fromwhat);
+
+	    if (len > PAM_MAX_RESP_SIZE)
+	      len = PAM_MAX_RESP_SIZE;
+	    pam_modutil_write(fds[1], fromwhat, len);
 	}
-	else
-	  pam_modutil_write(fds[1], "", 1);
+        pam_modutil_write(fds[1], "", 1);
+	if (towhat) {
+	    int len = strlen(towhat);
+
+	    if (len > PAM_MAX_RESP_SIZE)
+	      len = PAM_MAX_RESP_SIZE;
+	    pam_modutil_write(fds[1], towhat, len);
+        }
+        pam_modutil_write(fds[1], "", 1);
 
 	close(fds[0]);       /* close here to avoid possible SIGPIPE above */
 	close(fds[1]);
Index: pam-1.1.3/modules/pam_unix/passverify.c
===================================================================
--- pam-1.1.3.orig/modules/pam_unix/passverify.c	2016-03-17 13:08:26.300138793 -0500
+++ pam-1.1.3/modules/pam_unix/passverify.c	2016-03-17 13:08:26.292138836 -0500
@@ -1083,12 +1083,15 @@ getuidname(uid_t uid)
 int
 read_passwords(int fd, int npass, char **passwords)
 {
+        /* The passwords array must contain npass preallocated
+         * buffers of length MAXPASS + 1
+         */
         int rbytes = 0;
         int offset = 0;
         int i = 0;
         char *pptr;
         while (npass > 0) {
-                rbytes = read(fd, passwords[i]+offset, MAXPASS-offset);
+                rbytes = read(fd, passwords[i]+offset, MAXPASS+1-offset);
 
                 if (rbytes < 0) {
                         if (errno == EINTR) continue;
Index: pam-1.1.3/modules/pam_unix/passverify.h
===================================================================
--- pam-1.1.3.orig/modules/pam_unix/passverify.h	2016-03-17 13:08:26.300138793 -0500
+++ pam-1.1.3/modules/pam_unix/passverify.h	2016-03-17 13:08:26.292138836 -0500
@@ -8,7 +8,7 @@
 
 #define PAM_UNIX_RUN_HELPER PAM_CRED_INSUFFICIENT
 
-#define MAXPASS		200	/* the maximum length of a password */
+#define MAXPASS PAM_MAX_RESP_SIZE  /* the maximum length of a password */
 
 #define OLD_PASSWORDS_FILE      "/etc/security/opasswd"
 
Index: pam-1.1.3/modules/pam_unix/support.c
===================================================================
--- pam-1.1.3.orig/modules/pam_unix/support.c	2016-03-17 13:08:26.300138793 -0500
+++ pam-1.1.3/modules/pam_unix/support.c	2016-03-17 13:08:26.296138814 -0500
@@ -511,7 +511,12 @@ static int _unix_run_helper_binary(pam_h
 	/* if the stored password is NULL */
         int rc=0;
 	if (passwd != NULL) {            /* send the password to the child */
-	    if (write(fds[1], passwd, strlen(passwd)+1) == -1) {
+	    int len = strlen(passwd);
+
+	    if (len > PAM_MAX_RESP_SIZE)
+	      len = PAM_MAX_RESP_SIZE;
+	    if (write(fds[1], passwd, len) == -1 ||
+	        write(fds[1], "", 1) == -1) {
 	      pam_syslog (pamh, LOG_ERR, "Cannot send password to helper: %m");
 	      close(fds[1]);
 	      retval = PAM_AUTH_ERR;
Index: pam-1.1.3/modules/pam_exec/pam_exec.8
===================================================================
--- pam-1.1.3.orig/modules/pam_exec/pam_exec.8	2016-03-17 13:08:26.300138793 -0500
+++ pam-1.1.3/modules/pam_exec/pam_exec.8	2016-03-17 13:08:26.296138814 -0500
@@ -1,13 +1,13 @@
 '\" t
 .\"     Title: pam_exec
 .\"    Author: [see the "AUTHOR" section]
-.\" Generator: DocBook XSL Stylesheets v1.75.2 <http://docbook.sf.net/>
-.\"      Date: 06/04/2011
+.\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
+.\"      Date: 03/17/2016
 .\"    Manual: Linux-PAM Manual
 .\"    Source: Linux-PAM Manual
 .\"  Language: English
 .\"
-.TH "PAM_EXEC" "8" "06/04/2011" "Linux-PAM Manual" "Linux\-PAM Manual"
+.TH "PAM_EXEC" "8" "03/17/2016" "Linux-PAM Manual" "Linux\-PAM Manual"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -65,7 +65,9 @@ Print debug information\&.
 \fBexpose_authtok\fR
 .RS 4
 During authentication the calling command can read the password from
-\fBstdin\fR(3)\&.
+\fBstdin\fR(3)\&. Only first
+\fIPAM_MAX_RESP_SIZE\fR
+bytes of a password are provided to the command\&.
 .RE
 .PP
 \fBlog=\fR\fB\fIfile\fR\fR
@@ -110,7 +112,6 @@ A system error occurred or the command t
 .PP
 PAM_IGNORE
 .RS 4
-
 \fBpam_setcred\fR
 was called, which does not execute the command\&.
 .RE
@@ -146,7 +147,6 @@ make \-C /var/yp
 with effective user ID\&.
 .SH "SEE ALSO"
 .PP
-
 \fBpam.conf\fR(5),
 \fBpam.d\fR(5),
 \fBpam\fR(7)
Index: pam-1.1.3/modules/pam_unix/pam_unix.8
===================================================================
--- pam-1.1.3.orig/modules/pam_unix/pam_unix.8	2016-03-17 13:08:26.300138793 -0500
+++ pam-1.1.3/modules/pam_unix/pam_unix.8	2016-03-17 13:08:26.296138814 -0500
@@ -1,13 +1,13 @@
 '\" t
 .\"     Title: pam_unix
 .\"    Author: [see the "AUTHOR" section]
-.\" Generator: DocBook XSL Stylesheets v1.75.2 <http://docbook.sf.net/>
-.\"      Date: 05/31/2011
+.\" Generator: DocBook XSL Stylesheets v1.79.1 <http://docbook.sf.net/>
+.\"      Date: 03/17/2016
 .\"    Manual: Linux-PAM Manual
 .\"    Source: Linux-PAM Manual
 .\"  Language: English
 .\"
-.TH "PAM_UNIX" "8" "05/31/2011" "Linux-PAM Manual" "Linux\-PAM Manual"
+.TH "PAM_UNIX" "8" "03/17/2016" "Linux-PAM Manual" "Linux\-PAM Manual"
 .\" -----------------------------------------------------------------
 .\" * Define some portability stuff
 .\" -----------------------------------------------------------------
@@ -56,6 +56,10 @@ to work without being setuid\-root\&. Th
 \fBnoreap\fR
 module argument can be used to suppress this temporary shielding and may be needed for use with certain applications\&.
 .PP
+The maximum length of a password supported by the pam_unix module via the helper binary is
+\fIPAM_MAX_RESP_SIZE\fR
+\- currently 512 bytes\&. The rest of the password provided by the conversation function to the module will be ignored\&.
+.PP
 The password component of this module performs the task of updating the user\*(Aqs password\&.
 .PP
 The session component of this module logs when a user logins or leave the system\&.
@@ -261,7 +265,6 @@ session    required   pam_unix\&.so
 .sp
 .SH "SEE ALSO"
 .PP
-
 \fBpam.conf\fR(5),
 \fBpam.d\fR(5),
 \fBpam\fR(7)
